# 要件定義書 v0.4

## プロジェクト概要
オンラインで最大 4 人が遊べるターン制ボードゲーム「ハイロール」。プレイヤーはロール (役職) と共有デッキを選び、カードプレイとロール攻撃で相手の HP を 0 にすることを目標とする。

---

## 機能要件
### 1. ロビー / マッチ
- 公開・パスワード付きロビーの作成 / 参加。
- ロビー作成時に共有デッキを選択し、参加者は同じ山札を使用。
- WebSocket を使って参加/退出/開始イベントを push 配信。REST はフォールバック。
- `/api/lobbies/:id/start` でマッチを起動し、`matchId` を参加者へ通知。

### 2. ロール & デッキ選択
- 参加者は任意のロール ID を選択し、開始前であれば変更可能。
- 共有デッキは 60 枚 (既定) をシャッフルして `sharedDeck` に格納。捨て札は `sharedDiscard`。

### 3. ゲームプレイ
- Spe 降順で手番を決定。Bra を行動ポイントとして消費。
- クライアント UI では共有山札 / 捨て札 / 手札をリアルタイム表示。
- `/api/matches/:id/draw`, `/play`, `/roleAttack`, `/endTurn` を通じて Bra 消費とターン進行を制御。
- カード効果 (ダメージ / バフ / デバフ /ドロー) はサーバー側エンジン `GameEngine` が解決。

### 4. マッチメイキング (任意)
- プレイヤー名・ロール ID をキューに登録し、揃い次第 matchId を返す。

### 5. ログ & 観戦
- サーバーは `logs` に行動履歴を追加し、クライアントで最新 20 件を閲覧。
- 手番外のプレイヤーは基本操作不可。観戦モードでは UI を閲覧のみ。

---

## 非機能要件
- **パフォーマンス**: WebSocket イベント遅延 200ms 以内を目指す。
- **可用性**: `npm run dev` でクライアント + サーバー同時起動。ポート 4000 固定。
- **セキュリティ**: 現段階では匿名プレイ。将来的なトークン認証を想定し API は `playerId` + セッションを扱える構造にする。
- **スケーラビリティ**: 現状はメモリ内状態だが、Redis 等へ移行できるようモジュール分割。

---

## 技術スタック
- **フロントエンド**: React + TypeScript + Vite + socket.io-client
- **バックエンド**: Node.js (Express) + socket.io + ts-node-dev
- **共有型**: `src/shared` で TypeScript 型を共通化
- **テスト**: Jest (サーバー), React Testing Library (クライアント予定)

---

## 運用メモ
- 文字コードは必ず UTF-8。Shift_JIS のままコミットすると Vite で `Unexpected character` エラーに繋がる。
- `.env` で `VITE_API_URL` / `VITE_SERVER_URL` を切り替えた場合は Vite を再起動。
- `npm run dev:server` はポート 4000 固定。占有時は既存 Node プロセスを終了して再起動。
- `npm run typecheck` はサーバー (CJS) 設定のためクライアントの `import.meta` をそのまま扱えない。将来的に ESM ビルドへ移行予定。

---

## 今後の課題
1. WebSocket マッチ状態の完全同期 (REST のポーリング撤廃)。
2. カード効果バリエーション追加 (マーケット操作, コイン管理, 反射, 召喚など)。
3. 認証 / セッション管理の導入と API セキュリティ強化。
4. カスタムデッキエディタ & ストレージの提供。
5. クライアントのアクセシビリティ改善 (キーボード操作, 画面リーダー対応)。

---

この要件定義書は `docs/requirements_design.md`・`docs/card_workflow_and_spec.md` と合わせて更新し、仕様変更があれば必ずドキュメントに反映すること。
