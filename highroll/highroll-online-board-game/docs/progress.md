# 開発メモ / Progress Log (UTF-8)

## 運用メモ
- すべてのソースファイルは UTF-8 固定。Shift-JIS などを混在させると Vite で `Unexpected character` が発生する。
- 公開用のパッチノートは `docs/patch_notes_public.md`（短く要点のみ）。詳細な作業ログはこの `progress.md` に残す。
- パッチノートの書き方（内部用）は `docs/patch_notes_rules.md` を参照。
- クライアント / サーバー URL は `src/client/config/api.ts`（`withApiBase`, `SOCKET_URL`）と `.env`（`VITE_API_URL`, `VITE_SERVER_URL`）で切り替え。変更時は Vite を再起動する。
- サーバー（`npm run dev:server`）はポート 4000 固定。`EADDRINUSE` が出たら既存の Node プロセスを停止する。
- `npm run dev` でクライアントとサーバーを同時起動。WSL では `/mnt/c/.../highroll-online-board-game` で実行し、Windows 側と二重起動しないようにする。
- `npm run typecheck` は CJS 出力のため `import.meta` を直接扱えない。将来的に ESM 化するか `define` で注入する。
- dev:client が落ちる場合は Node のバージョンが v24 系に戻っていないか確認する（`node -v`）。推奨は LTS（v22 または v20）。
- nvm 利用時は以下で LTS を固定する:
  - `nvm install 22`
  - `nvm use 22`
  - `node -v`

### オンライン確認（Quick Tunnel）手順
1. WSL の `game/highroll/highroll-online-board-game` で `npm run dev` を起動する。
2. 別ターミナルで `curl http://127.0.0.1:5173` を確認し、HTML が返ることを確認する。
3. 同じ WSL で `cloudflared tunnel --url http://localhost:5173` を実行し、表示された `trycloudflare.com` の URL を開く。
4. 画面が開いたら `/api` や `/socket.io` が同一トンネルで到達する（API 用の別トンネルは不要）。
5. 502 が出る場合は、`dev:client` が落ちていないか / 実行ディレクトリが違わないかを確認する。

---

## 2026-02-03
### Done
- Workers + Durable Objects（WebSocket）構成の下準備を進行（`workers/`）。
- `vite.config.ts` の `/api` proxy を WebSocket 対応（`ws: true`）。
- `npm run dev:cf` を追加（wrangler dev を `:4000` で起動し、Vite から `/api` を同一ポートへ proxy）。
- `Match.tsx` を `/api/rooms/:id/ws` の state push 購読に対応（指数バックオフで再接続、ping/pong、開発時のみ polling フォールバック）。
- 内部メモを更新：`docs/online_workers_do.md`（ローカル起動手順、エンドポイント修正）。
- `workers/` を「RoomDO + /api/rooms」構成に更新（`wrangler.toml`, `RoomDO`, `GET /api/cards` の追加）。
- フロントの接続先切替用に `VITE_API_BASE` を導入（`.env.development`, `.env.production`）。

## 2026-01-29
### Done
- ロール：［爆弾］に「時限爆弾」アビリティを追加（対象のターン終了ごとにカウント減少、0で固定10ダメージ）。
  - 反動扱いにしないため、自分には設置できないようにした。
  - バグ修正：時限爆弾の爆発は「攻撃」扱いではないため、爆弾の反動/反射が発生しないようにした。
- サーバー：出血（`bleedStacks`）を実装。
  - 行動する度に特殊1ダメージ（※ターン終了は別処理）。
  - ターン終了時に特殊1ダメージ＋出血-1。
- サーバー：装備【ふしぎなまもり】の「特殊ダメージ無効」を実装（炎上/出血などの `status` ダメージを0にする）。
- サーバー：フェイントの「防御カード無視」を実装（次のロール攻撃のみ、相手の防御カードを無視）。
- サーバー：次のロール攻撃Atkボーナスを実装（`setNextRoleAttackAtkBonus` → 次のロール攻撃で消費）。
- サーバー：吸血のロール攻撃効果を実装（出血付与＋回復）。
- サーバー：血の剣（装備）のロール攻撃後「出血+2」を実装。
- データ：新カード / 新ロールの追加（`data/cards.json`, `data/roles.json`）。
- クライアント：状態異常チップに「出血」を追加。
- クライアント：ダメージ結果ポップアップの表示を調整（特殊ダメージ/自傷は専用見出し）。
- クライアント：ダメージ結果ポップアップの見出しに、可能なら種別（炎上/出血/反動など）も表示するように。
- クライアント：吸血のアビリティ「血の紋様」をポップアップで手札選択できるように対応。
- ターンログ改善
  - 継続効果ログの表記を「炎上/出血: nダメージ（または回復）」の形式に変更。
  - ターンログに「ダメージ結果（attempted→after）」も表示するように変更（直近20件）。
  - カードがもたらした効果（ドロー/回復/Bra増減/追加トークン/状態異常/封印/手札捨て）もターンログに表示するようにした。
- クライアント：血の紋様が付いた手札カードに「血」マークのオーバーレイを表示し、ツールチップにも「血の紋様」表示を追加。
- クライアント：呪い/血の紋様のツールチップを、見出しテキスト（【】）ではなくアイコン（🪄/🩸/📝）で表示するように調整。
- デッキ：拡張デッキ（90枚）に追加カード群を反映（不足分を追加し、枚数バランスを調整）。
- クライアント：呪い/血の紋様の手札バッジを、文字ではなくアイコン（🪄/🩸）で表示するように調整。

### Notes
- 「ふしぎなまもり」による無効化は、ダメージ結果ポップアップの `breakdown` に理由が出る。

---

## 2026-01-27
### Done
- `docs/requirements.md` の文字化け（Shift-JIS/誤デコード由来）を解消し、仕様ドキュメントへの入口として作り直し。
- 仕様上の丸め規則（明記がなければ切り捨て）を `docs/requirements_design.md` に追記。
- 「ひらいしん」の説明を更新し、感電トークン獲得は「装備中のターン開始時のみ」に統一（装備時の獲得は廃止）。
- 拡張デッキ `data/decklist.expanded_mixed_90.json`（90枚）を追加。
- 拡張デッキ内の装備カードを各1枚に調整。
- 「次のうちどれか選ぶ」（chooseOne）を、ブラウザのconfirm/promptではなくゲーム内ポップアップで選択できるように変更。

---

## 2026-01-13
### Done
- roles.json / decklist.* を読み込むサーバーサイドユーティリティを実装。
- パスワード付きロビー作成と簡易マッチメイキングを REST で整備。
- 共有デッキからのドロー / カードプレイ API を用意し、プロトタイプレベルの Lobby / Match UI で動作確認。

### Next / Issues
- ロビーイベントとマッチ状態を WebSocket 化（REST はフォールバック用途）。
- Spe / Bra を反映したターン制ルールと共有山札挙動を仕様通りに実装。
- カード効果・ターン終了処理・再シャッフルロジックをサーバー側に寄せる。
- 認証 / セッション層を導入して `playerId` の手動送信を不要にする。

---

## 2026-01-14
### Done
- Match 画面に共有山札 / 捨て札 / 手札のリアルタイム表示を追加し、GameEngine に Bra 消費と Spe 順決定を反映。
- `/api/matches` に `draw` / `play` / `endTurn` を追加し、クライアントから Bra / ターン操作が可能に。
- WebSocket ロビーゲートウェイを導入し、`lobby:<id>` チャンネルで参加 / 退出 / 開始を push 配信。
- プロトタイプ用ロール / デッキデータを整備し、`docs/requirements.md` を更新。

### Clarified Requirements
- 通信は WebSocket を基本チャネル（REST はフェイルセーフ用途）。
- 共有山札: ロビー作成時に選んだデッキを全員で共有し、山札が尽きたら捨て札をシャッフル。
- ターン制: Round 開始時に Spe 順で手番決定 → 初期手札は Spe 順で 3 枚ずつ → Bra を行動ポイントとし 0 になっても即終了しない（End Turn ボタンで明示）→ 通常ドローはゲーム開始時のみ、以降はカード効果で補充。

### Upcoming Tasks
1. ロビー更新 / マッチ状態 / 開始通知を WebSocket へ統合。
2. ダメージ / バフ / ターン管理などサーバーエンジンを拡張。
3. セッション管理を導入して API 側で `playerId` を渡さなくても済むようにする。
4. カスタムデッキ UI / ストレージを検討し、ロールとデッキ種類を拡大。

---

## 2026-01-15
### Done
- `POST /api/lobbies/:id/start` で `engine.start()` を実行し、共有山札配布 / 手番決定をサーバーで完結。
- `lobbyStarted` イベントを broadcast し、参加者を自動画面遷移（`/match/:id`）。
- `createMatch` で追加されたレイヤーを強制 Ready 扱いにし、開始時の手番未設定を防止。
- `client/config/api.ts` のデフォルト URL を `http://localhost:4000` に戻して Vite プロキシ経由の `ECONNREFUSED` を回避。Lobby 画面に API Health チェックと復旧ガイドを追加。
- Match 画面の手札 UI をカード風タイルへ刷新。`cards.json` から名称 / コスト / 説明を読み込み、WebSocket 経由の開始イベントにも対応。
- `sessionStorage` に playerId / name を保持し、ブラウザ再読込でも同じプレイヤーを操作できるようにした。
- 観戦モードと操作権限表示を追加し、ターン情報 / 山札残数を UI で視覚化。

### Notes
- カード効果とマッチ中のリアルタイム更新は未対応。今後のタスクで継続。
- API 接続エラー時は赤帯に復旧手順（`npm run dev` / ポート 4000）を表示。

---

## 2026-01-17
### Done
- GameEngine に `PlayerRuntimeState` を実装し、HP / TempHP / トークン / インストール / 敗北状態を管理。
- `dealDamage`, `addStatToken`, `discardAllHand`, `doubleBaseStat`, `thresholdPrevent`, `cheatDeathAtFull` などサーバー側のカード効果を実装。
- 行動ログ (`logs`) を追加し、ターン開始 / カード使用 / ロール攻撃 / 戦闘不能を記録。
- ロール攻撃 API (`POST /api/matches/:id/roleAttack`) を追加し、Era >= 1 で通常攻撃、Bra = 0 で悪あがきを再現。
- HP <= 0 のプレイヤーを自動脱落させ、最後の 1 人で勝敗を決定。
- クライアント Match 画面にロール攻撃 / 悪あがきボタンを追加し、Bra 0 時の挙動を明示。
- プレイヤーカードのホバーで基礎ステータス / トークン / ブースト / TempHP を表示し、脱落者は「戦闘不能」扱いに。

### Next
- カードテンプレートを拡張（マーケット操作、コイン生成など）し、`card_workflow_and_spec.md` と合わせて管理。
- WebSocket でマッチ更新を push 化し、秒ポーリングを廃止。
- `jest-environment-jsdom` でテスト環境を整え、サーバーテストを CI で通す。

---

## 2026-01-18
### Done
- `src/client/config/api.ts` と `useGameClient.ts` の接続先を同一オリジン優先（必要に応じて環境変数で上書き）へ変更し、Cloudflare トンネル 1 本で API / Socket.io も動作するようにした。
- Vite の proxy に `/socket.io`（`ws: true`）を追加し、開発サーバー経由でも WebSocket がポート 4000 の Node サーバーへ中継されるよう調整。
- `vite.config.ts` の `allowedHosts` を `.trycloudflare.com` + `VITE_ALLOWED_HOSTS`（カンマ区切り）で柔軟に指定できるよう整理。
- 変更内容を `docs/progress.md` に追記し、Cloudflare Quick Tunnel 運用メモを更新。

### Notes
- Quick Tunnel では `npm run dev` を起動した状態で `cloudflared tunnel --url http://localhost:5173` を実行するだけで `/api` / `/socket.io` が backend に届く。個別に API 用トンネルを立てる必要はない。

---

## 2026-01-07
### Done
- 反響（`resonate`）の連続攻撃を 2/3 減衰に変更し、説明文を更新。
- 疾風（`swiftwind`）の追加 Spe 軽減は「ロール/カードダメージのみ」適用に限定。
- トゥワイスブーストの増幅量を「基礎値ぶん」に固定し、増幅分だけ現在 HP を減らす仕様を追加。
- やばい粉の説明文を「Bra トークン -1（最大 Bra 減少）」に更新。
- `cards.json` の「トゥワイスブースト」「やばい粉」説明文の文字化けを修正。
- `roles.json` の「疾風」説明文の文字化けを修正。
- `roles.json` / `roles_compiled.json` の「反響」説明文の文字化けを修正。
- 防御カード発動や疾風の Spe 軽減など、被ダメ軽減ログをターンログに追加。
- 軽減ログに「どの効果で軽減したか」を具体的に表示（カード名 + 条件、疾風は Spe 消費量）。
- 追加トークン（Atk/Def/Spe/Bra）のマイナスを許可し、Bra は基礎 + 追加トークン値をターン開始時に反映。
- プレイヤー名/ロビー名は8文字以内・英数字/ひらがな/カタカナ/漢字のみ許可するバリデーションを追加（サーバー側）。
- プレイヤー名/ロビー名の入力チェックをクライアント側にも追加（最大8文字・許可文字のみ）。
- Match画面の対象選択・ステータス選択をポップアップ化（事前のプルダウン選択を撤廃）。
- Match画面の「対象を選ぶ」「ステータスを選ぶ」ボタンを削除（ポップアップのみで選択）。
- 装備カードは1枚のみ装備可能に変更（新規装備時に既存装備は捨て札へ）。
- トゥワイスブーストのステータス選択からBraを除外（サーバー/クライアント両方で防止）。
- ロビー詳細APIとロビー画面の参加者一覧/ロール選択を追加。
- ロビー内でロールが重複した場合、開始時に片方をランダムで変更する処理を追加。
- 対象選択ポップアップは毎回表示するよう変更（前回選択の固定を解消）。
- ロビー詳細を独立画面に分離（`/lobby/:id`）。ロビー開始/退出/参加者一覧/ロール選択をロビー画面で操作可能に。
- デッキ内容の枚数表示を「残り/全体」に簡略化し、残り0枚は赤表示に変更。
- ホストが「他プレイヤーのロール公開」を切り替えられるようにし、非公開時は自分のロールのみ表示。
- デッキ残りは「未使用枚数（デッキ+手札）」として表示し、ドローでは減らず使用時にのみ減るよう変更。
- 右上のデッキボタンは未使用枚数表示のまま維持し、ステータス欄は山札/捨て札枚数を表示。
- ロビーの最大参加人数を6人に拡張（参加時に上限チェックを追加）。
- ロビー参加時に「観戦モード」を選択可能にし、観戦者はロール選択と準備OKの対象外に変更。
- 準備OKボタンを追加し、ホストは非ホスト参加者が全員準備OKになるまで開始できないように調整。
- バトル画面のプレイヤー詳細をカード上に重ねて表示し、開閉時にレイアウトが動かないように変更。
- 全滅時の勝敗判定を追加（反動などで自滅した側が負け扱いになるよう補正）。
- Match画面の道化演出（jester）の初期化順を修正し、起動時のReferenceErrorを解消。

### Notes
- 反響の説明は `roles.json` / `roles_compiled.json` の両方を更新。
- トゥワイスブーストの HP 減少は現在 HP から直接引く（TempHP は対象外）。

---

## 現状まとめ
- カタログ API / ロビー作成 / マッチ進行 / カード操作 / Bra 制御 / ロール攻撃まで実装済み。
- 行動ログ・ターン表示・観戦モードにより最低限のプレイ体験を確認済み。
- 残課題: WebSocket リアルタイム同期、カード効果拡張、認証・セッション管理、カスタムデッキ UI など。

---

このファイルは進捗ごとに更新し、仕様ドキュメント（`requirements*.md`）と実装の差異があれば補足する。

---

## 2026-01-19
### Done
- Match画面にヘルプボタン（? / デッキ）を追加し、ルールとデッキ内容をモーダルで確認できるようにした。

## 2026-01-20
### Done
- 被ダメージ前のインストール系カード（ガラスシールド／ロックバリア等）で割り込み確認を出せるよう、pendingPrompt と resolvePrompt を追加。
- Match 画面に割り込みモーダルを追加し、対象プレイヤーのみが「使う／使わない」を選択できるようにした。
- 割り込み確認中は各種操作をブロックして整合性を保つようにした。


## 2026-01-21
### Done
- 新規カードを追加（論理的思考 / 誘惑の粉 / ハートのガラス / 懐に入る / かえんほうしゃ / スタングレネード / 反撃の狼煙）。
- 追加効果タイプ（drawCards / adjustBra / applyStatDebuffUntilDamage / applyBurn / applyStun / heal / modifyMaxHpInstall）を実装。
- 数ターン系のデバフ（スタン）や次ダメージまでの弱体をステータス表示に追加。

---

## 2026-01-09
### Done
- 新ロール「効率」「貪欲」「延期」を追加し、エンジン側でカード効果倍率・トークン獲得時の回復・延期行動を実装。
- 延期は最初の行動後に残り Bra を保持し、全員の行動後に継続行動できるようターン処理を拡張。
- カード効果が補正される場合、ホバー時ツールチップで元値と補正値を色分け表示する UI を追加。


## 2026-01-22
### Done
- 装備（subtype: equip）のみ同時装備不可とし、ガラスシールドやハートのガラスなど非equipの設置カードは複数保持できるようにした。


## 2026-01-23
### Done
- トリックルーム効果中をMatchヘッダで表示し、効果時間（〜R n）を視覚化。
- ターン順効果（modifyTurnOrder）を実装し、ラウンド期限で自動解除するようにした。

---

## 2026-01-24
### Done
- 手札にある間だけ効果を持つカード用に `handStatModifier` を追加し、手札の増減時にトークンを再計算するようにした。
- プレイできないカード用に `playable: false` を追加し、手札UIとサーバーでプレイ禁止を反映した。
- 新カード「攻撃のお守り」「脆弱の呪い」を追加し、基本デッキで反撃の狼煙/スタングレネードを各1枚ずつ減らして差し替えた。

---

## 2026-01-25
### Done
- ダメージ割り込み（防御カード）ポップアップに「攻撃者→対象 / 種別 / 与えようとしているダメージ / 防御カード / 予測（実際に受けるHPダメージ・Temp吸収）」を統合して表示。
- サーバー側で `pendingPrompt.preview` を生成し、割り込み「使う/使わない」それぞれの被ダメ予測をクライアントへ渡すようにした（現状は簡易推定）。
- Match 側の割り込みモーダル内で防御カード表示が重複していた箇所を整理。
- 全てのダメージで「与えようとした/実際に受ける（Temp吸収/HPダメージ）」をポップアップ表示するため、`damageResolved` ログを追加してクライアント側で表示（自動で順番に表示）。
- `applyDamageToPlayer` の戻り値を「HPダメージだけ」ではなく「Temp吸収 + HPダメージ」の合計に修正（反響などの連続攻撃がTempHPで止まる問題を回避）。
- ダメージ結果ポップアップの表示を見やすく改善（「誰→誰」を大きく1行、ダメージを「予定→実際」で表示、内訳は別ブロック）。
- Match画面をカードゲームっぽい見た目に寄せるため、背景（プレイマット風）と主要カード/ボタンの質感を調整（`Match.module.css`）。
- `npm run dev` の起動順をサーバー→クライアントに変更し、起動直後の `/api` 叩きによる `ECONNREFUSED` を減らす（`package.json`）。
- `wait-on` を導入し、`dev:client` は `http://127.0.0.1:4000/health` を待ってから Vite を起動するように変更（起動直後の proxy エラーを抑制）。
- 最大Braが0のときの救済アクションを追加（自分のターン中のみ）。最大HPの1/4（切り捨て、最低1）を消費し、最大Braを恒久的に+1（このターンのBraも+1）。
- 救済アクション実行時に `window.confirm` を出さず、条件を満たす場合は即実行に変更（画面上部に確認が出ないように）。
- CPUプレイヤー（EASY/NORMAL/HARD）を追加し、CPU手番はサーバー側で自動進行するようにした（防御カード割り込みもCPU対象なら自動判断）。
- CPU の対象選択で `chosen_player` を「自分」と固定せず、デバフ/状態異常系（例: かえんほうしゃ）は相手を選ぶように修正。
- 「ソロで即マッチ開始」は `NORMAL` のCPUを1人追加して即スタートするようにした（`/api/matches/solo`）。
- CPU追加はロビー作成後（ロビー画面）にホストが人数（1〜）と強さを指定して追加できるようにした。
- ルート（`/`）に表示されるページ名を「ホーム」に変更し、ロビー画面（`/lobby/:id`）と名前が被らないようにした。
- 観戦モードはロビー参加後に切り替えできるようにした（`/api/lobbies/:id/spectator`、ホストは切替不可）。

---

## 2026-01-26
### Done
- 新カードを追加: 「再構築」「アームシールド」「脳注射」「バックショットルーレット」「はやてのつばさ」「アドレナリン」「ほのおのよろい」。
- 「再構築」用に `discardThenDraw`（手札を指定枚数捨て、その枚数だけドロー）を実装（現状はランダムに2枚捨てる）。
- 「アームシールド」用に `reduceDamageOnce`（次に受ける攻撃ダメージを固定値軽減して自身を捨てる）を実装。
- 「脳注射」「バックショットルーレット」用にコイントス系の効果 `coinFlipDealDamage` / `coinFlipDealDamageEither` を実装。
- 「はやてのつばさ」用に `setNextRoundPriority` を実装（次ラウンドのターン順で、通常は先頭・トリックルーム中は末尾に移動）。
- 「アドレナリン」用に `adrenaline` を実装（このターン含め2回の自分ターン終了までバフ維持→次の自分ターン終了時に反動を付与）。
- Match のプレイヤー表示で「アドレナリン/反動」を状態異常チップとして表示（残り回数や効果をツールチップで確認可能）。
- Match のプレイヤー表示で「はやてのつばさ」をバフ（次ラウンド）として表示。
- 「ほのおのよろい」用に `contactBurnOnRoleAttack` を実装（装備者にロール攻撃した相手に火炎+1）。
- ロール「延期」の仕様を変更: ラウンド中に受けたダメージは即時にHPへ反映せず、「延長ターン開始時」にまとめて受けるようにした。
- ホーム画面で `docs/progress.md` のパッチノートを閲覧できるようにした（折りたたみ表示）。
- ロール詳細テキストの見出しを `パッシブ1:` / `パッシブ2:` / `アビリティ:` 形式に整理し、不要な表記（例: `（常時）`）を削除。

---

## 2026-01-27
### Done
- 「かえんほうしゃ」の火炎付与を 3 → 2 に修正。
- 新カード「はじけるほのお」を追加（対象1人に火炎3、その後その他に火炎1）。
- 新カード「消火器」を追加（次のうちどれか選ぶ→対象1人：火炎-3 / 通常5ダメージ）。
- ジャブ等の「カードダメージ（Defで軽減される）」はログ/ポップアップ上の種別表示を「通常ダメージ」に変更。
- カード文面の用語を整理（「通常ダメージ」「固定ダメージ」に統一。旧表記の「(Defで軽減される)/(Defを無視)」系は廃止）。
- ゲーム内ヘルプ（ルール/進め方）に用語説明を追記（通常ダメージ / 固定ダメージ / 火炎 / 「次のうちどれか選ぶ」）。
- 新ロールを追加
  - ［強欲］HP.２０　Atk.５　Def.２　Spe.６　Bra.１
    - 「次のうちどれか選ぶ」を持つ効果は、すべての選択肢を発動する
    - （更新）全発動時は、選択肢ごとに対象/選択を独立に決めて解決できるようにした（同じ対象に固定されない）
  - ［脱皮］HP.２０　Atk.１　Def.９　Spe.１　Bra.１
    - アビリティ1：Braを1消費して脱皮する
      - Defを0にし、失ったDefの半分（切り捨て）をAtk/Speに追加トークンとして得る
- ダメージ結果ポップアップに、消えるまでの残り時間が分かるプログレスバーを追加。
- ロール詳細でBra消費項目が複数ある場合は「アビリティ1/2/...」の形式で表記するように変更（例: 医師）。
- CPUの行動が速すぎて分かりにくい問題に対応し、CPU行動の間隔に待機時間を追加（現在は約1.0秒）。
- 攻撃以外の行動も把握しやすいよう、カード使用/ロールアクション/ターン開始なども簡易ポップアップ表示するように追加。
- 新ロールを追加
  - ［封印］HP.２０　Atk.０　Def.０　Spe.０　Bra.２
    - Braを1消費して「攻鎖 / 防鎖 / 速鎖 / 封鎖」のいずれかを実行できる
    - 封鎖：対象のランダムな手札1枚を封印し、封印された手札は使用できない
    - 封印された手札は×（封印マーク）のオーバーレイで表示する
- ロール詳細の表記方針を調整（ステータス面の特徴は「パッシブ/アビリティ」を付けず、単なる説明として書く）。

---

## 2026-02-03
### Done
- Workers + Durable Objects（DO）でオンライン化するための最小骨格を追加（内部用）。
  - `workers/` を追加し、Worker 側に `/api/match/create` と `/api/match/:id/ws` を用意。
  - `MatchDO` を追加し、WebSocket 接続管理＋プレイヤー一覧の同期（`matchState` 配信）まで実装。
  - 無料枠運用を想定し、ポーリングではなく「WS常時接続 + イベント駆動」へ寄せる方針を明文化。
  - 詳細メモ：`docs/online_workers_do.md`

### Notes
- これは highroll の Node/soket.io をそのまま移植するものではなく、Workers/DO 向けに通信方式を標準 WebSocket（JSON）へ置き換える前提の土台。

---

## 2026-01-28
### Done
- 新ロールを追加
  - ［巨人］HP.１００　Atk.７　Def.０　Spe.０　Bra.１
    - 装備カード / 防御カードを使用できないようにした（サーバー側で禁止）。
    - Def / Spe は 1 以上にならないようにした（サーバー側で上限 0）。
    - ロール攻撃時、与えたダメージの 1/2（切り捨て）を自分も受ける（反動）。
    - ロール攻撃時、攻撃したプレイヤーにめまい1を付与する。
  - ［魔女］HP.１５　Atk.４　Def.２　Spe.７　Bra.２
    - アビリティ1：呪い付与（Bra1消費、対象の手札ランダム1枚にランダム呪いを付与）。
    - パッシブ1：呪文カードを使うたび、最大HP+1 / HP+1（抑制中は無効）。
- 呪いシステムを追加（手札カードに対して付与される追加ルール）
  - 呪い付き手札を `cursedHand` として runtime state に保持し、手札の増減（捨てる/ドロー/全捨て等）に追従するようにした。
  - 呪いの例
    - 「衰弱の呪い」：手札にある間、追加Def-1（手札の状態に追従して自動再計算）。
    - 「強制の呪い」：使用可能な強制カードがある場合、それ以外を使用不可。
    - 「減衰の呪い」：そのカードの数値を -2（カード解決中のみの一時補正として適用）。
    - 「崩壊の呪い」：自分のターン終了時に、そのカードを捨て札にする。
    - 「代償の呪い」：そのカード使用時に固定2ダメージを受ける（不発でも発動）。
    - 「反駁の呪い」：そのカード使用時、手札から1枚選んで捨てる（ゲーム内ポップアップで選択）。
    - 「激昂の呪い」：そのカードは通常より Bra を 1 多く消費する。
    - 「共振の呪い」：対象選択のある効果は、自分にも同じ効果を適用（簡易ミラー）。
    - 「沈黙の呪い」：そのカード使用後、ターンを強制終了する。
    - 「摩耗の呪い」：そのカード使用時、追加Atk-1（不発でも発動）。
- 同名カードが手札に複数あるケースに対応するため、カード使用 API に `handIndex` を追加
  - サーバー側は `handIndex` を優先して「どの手札を使用したか」を特定する。
  - クライアント/CPU も `handIndex` を送るようにし、封印/呪い/強制などの判定が安定するようにした。
- UI
  - 呪い付き手札カードに「呪」マークを表示し、ツールチップでも呪い名を見える化。
  - 呪い付き手札カードのツールチップに、呪いの効果説明も表示するようにした。
  - 「反駁の呪い」など追加の選択が必要な場合、ゲーム内ポップアップで選択できるようにした。
- パッチノート
  - 公開用の更新履歴を `docs/patch_notes_public.md`（v0.3.6 / 2026-01-28）に追記した。
- カード調整
  - 「ジャブ」：接触通常３ダメージに変更（接触攻撃として扱う）。
- 不具合修正
  - 防御系の割り込み（thresholdPrevent / damageIntercept）が、炎上などの継続ダメージにも反応してしまうケースがあったため、デフォルトではロール/カードダメージのみ対象に修正した（必要なら `sources` で明示）。
